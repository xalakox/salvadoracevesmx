{"componentChunkName":"component---src-templates-blog-post-js","path":"/nodejs-debug-docker-vscode/","result":{"data":{"site":{"siteMetadata":{"title":"Blog"}},"markdownRemark":{"id":"80d6b0b3-5943-5582-8db1-46b306dc2cc5","excerpt":"I wont’t lie if I stated there was a before and after using the NodeJS debugger on a daily basis, however, there was yet another before and after handling the…","html":"<p>I wont’t lie if I stated there was a before and after using the NodeJS debugger on a daily basis, however, there was yet another before and after handling the debugging inside my IDE (VSCode).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/713407677149962ff30c736defe799e7/9b3f4/poster.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGeXIMEkf/EABoQAAEFAQAAAAAAAAAAAAAAABEAAhAhIjH/2gAIAQEAAQUCyhTeEz//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAZEAABBQAAAAAAAAAAAAAAAAAAAQIgIUH/2gAIAQEABj8CdWCx/8QAGxABAAICAwAAAAAAAAAAAAAAAQARMUFRYXH/2gAIAQEAAT8hC1xnXTLaGjmMF7FxiXP/2gAMAwEAAgADAAAAEGA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRABAAMBAQAAAAAAAAAAAAAAAQARITHx/9oACAEBAAE/EKaxEd1pjL0XYashBRYQV9mpb72DJ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fancy brogrammer setup\"\n        title=\"fancy brogrammer setup\"\n        src=\"/static/713407677149962ff30c736defe799e7/88218/poster.jpg\"\n        srcset=\"/static/713407677149962ff30c736defe799e7/7237a/poster.jpg 148w,\n/static/713407677149962ff30c736defe799e7/0cfdf/poster.jpg 295w,\n/static/713407677149962ff30c736defe799e7/88218/poster.jpg 590w,\n/static/713407677149962ff30c736defe799e7/77d57/poster.jpg 885w,\n/static/713407677149962ff30c736defe799e7/5a917/poster.jpg 1180w,\n/static/713407677149962ff30c736defe799e7/9b3f4/poster.jpg 1950w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Like many of you I develop NodeJS apps and a lot of the times these apps have to be handled inside of containers, because keeping track of the NodeJS versions for every app can lead to unnecessary host system complexity, sometimes you need to get several servers up simultaneously (i.e. microservices apps) and it would require to maintain multiple shell sessions to switch the NodeJS version between them; but this is not a compaint post against <a href=\"https://github.com/nvm-sh/nvm\">nvm</a>, rather how I had to set it up to work inside Docker.</p>\n<p><em>.Dockerfile</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM node:8.10\nCOPY . /app\nWORKDIR /app\nRUN echo &quot;deb [check-valid-until=no] http://archive.debian.org/debian \\\njessie-backports main&quot; &gt; /etc/apt/sources.list.d/jessie-backports.list\nRUN sed -i &#39;/deb http:\\/\\/deb.debian.org\\/debian jessie-updates main/d&#39; \\\n/etc/apt/sources.list\nRUN apt-get -o Acquire::Check-Valid-Until=false update\nRUN apt-get install -yq psmisc\nRUN npm install --silent\nCMD [&quot;npm&quot;, &quot;run&quot;, &quot;dev&quot;]</code></pre></div>\n<p>Most of the setup is to be able to install <a href=\"http://psmisc.sourceforge.net/\">psmisc</a> that includes a tool called fuser, what that utility will allow us is to terminate the execution of node or rather restart it on a more stable way; for some reason when we are running the inspect flag on node we have a sticky port situation where the process hangs to the port and it will not be able to kill the connection to the attached debugger on time, so this helps; there is a node only alternative for killing processes port based, however, it was not stable enough to be useful, going system utility mode is just more stable.</p>\n<p>And now for the package.json setup (scripts section):</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jest -i --bail --coverage --forceExit\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token property\">\"inspect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fuser -k 9231/tcp; fuser -k 7070/tcp; node --inspect=0.0.0.0:9231 server.js\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token property\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm install &amp;&amp; nodemon --delay 180ms -L --config /app/nodemon.json --exec 'npm run inspect'\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node server.js\"</span>\n   <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Ignoring test and start which are scripts intended for devOps and production running; I am using two commands for running this app, the first one (dev) which is referred at the Dockerfile as default runs an instance of <a href=\"https://www.npmjs.com/package/nodemon\">nodemon</a> with the L flag that makes it run more stable inside of Docker with a mapped volume on the host system and an inspect command that makes it easier to read this file kills the processes that are bound to ports 9231 (in this case the debugging port and port 7070 which is my default app port, you should accommodate for your own default app port. I am also telling nodemon to pull a configuration file from nodemon.json that handles exceptions and other details.</p>\n<p>With this setup the app will start inside of Docker waiting on a connection on ports 9231 and 7070, so it’s important to map these ports when running Docker, I normally use <a href=\"https://docs.docker.com/compose/\">docker-compose</a> do setup my environment and the ports mapped, the following is an example configuration for this particular setup.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">backend:\n  build: ./../backend\n  container_name: &quot;backend&quot;\n  ports:\n    - 7070:7070\n    - 9231:9231\n  volumes:\n    - ./../backend:/app\n    - /app/node_modules\n  env_file: ./../backend/.env\n  depends_on:\n    - mongodb</code></pre></div>\n<p>Using this setup helps us maintain the docker-compose file as it’s own repository and we can have an env file to maintain the session variables required for the app to run.</p>\n<p>Now all that is left is to configure vs code to connect to the debugger, it is pretty much straight forward, create or start the VSCode debugger to have it create a folder named .vscode on the root of the project, then on a file named launch.json include:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;version&quot;: &quot;0.2.0&quot;,\n  &quot;configurations&quot;: [\n    {\n      &quot;type&quot;: &quot;node&quot;,\n      &quot;request&quot;: &quot;attach&quot;,\n      &quot;name&quot;: &quot;Docker: Attach to server&quot;,\n      &quot;port&quot;: 9231,\n      &quot;address&quot;: &quot;localhost&quot;,\n      &quot;localRoot&quot;: &quot;${workspaceFolder}&quot;,\n      &quot;remoteRoot&quot;: &quot;/app/&quot;,\n    },\n  ]\n}</code></pre></div>\n<p>And that’s it, just connect to the instance using F5 or re-run the app on the instance using Ctrl+Shift+F5 to restart and reconnect.</p>\n<p>Addendum [Apr 30 2019]\nYou might want to skip stepping into dependencies or JavaScript internals (like promise handling) adding this to the launch.json config file of VSCode:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;skipFiles&quot;: \n  &quot;${workspaceFolder}/node_modules/**/*.js&quot;,\n  &quot;&lt;node_internals&gt;/**/*.js&quot;\n]</code></pre></div>","frontmatter":{"title":"NodeJS in Docker debugging with VSCode","date":"April 26, 2019","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/nodejs-debug-docker-vscode/","previous":{"fields":{"slug":"/about-salvador/"},"frontmatter":{"title":"About Salvador"}},"next":null}}}